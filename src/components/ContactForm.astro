---
import { site } from "../data/site";
const defaultAction = `mailto:${site.email}`;
---
<section id="contact" class="py-16" aria-labelledby="contact" data-reveal>
  <div class="max-w-2xl mx-auto text-center">
    <h2 id="contact" class="text-xl font-semibold text-fg">Contact</h2>
    <p class="text-fg/90 mt-1">Have a collaboration or role in mind? Send a message.</p>
  </div>
  <form class="mt-6 space-y-4 max-w-xl mx-auto" data-enhanced={Boolean(site.forms?.endpoint)}
        method="post"
        action={site.forms?.endpoint ?? defaultAction}
        onsubmit="if (!this.checkValidity()) { return; } try { if (!this.action || this.action.startsWith('mailto:')) { const s = this.querySelector('[name=subject]'); const m = this.querySelector('[name=message]'); const subject = encodeURIComponent(s?.value || 'Portfolio contact'); const body = encodeURIComponent(m?.value || ''); this.action = (this.action || '${defaultAction}') + '?subject=' + subject + '&body=' + body; } } catch(_) {}">
    <!-- Honeypot to deter simple bots -->
    <input type="text" name="website" tabindex="-1" autocomplete="off" class="hidden" aria-hidden="true" />
    <div class="grid sm:grid-cols-2 gap-4">
      <div>
  <label class="block text-sm text-muted" for="name">Name</label>
  <input id="name" name="name" type="text" required class="mt-1 input" />
      </div>
      <div>
  <label class="block text-sm text-muted" for="email">Email</label>
  <input id="email" name="email" type="email" required class="mt-1 input" />
      </div>
    </div>
    <div>
  <label class="block text-sm text-muted" for="subject">Subject</label>
  <input id="subject" name="subject" type="text" class="mt-1 input" />
    </div>
    <div>
  <label class="block text-sm text-muted" for="message">Message</label>
  <textarea id="message" name="message" rows="5" required class="mt-1 input"></textarea>
    </div>
    <div class="flex items-center gap-3 justify-center">
      <button type="submit" class="px-4 py-2 rounded bg-white text-black hover:bg-white/90 transition">Send</button>
    </div>
    <p class="text-sm text-muted text-center hidden" id="status" role="status" aria-live="polite"></p>
  </form>
  

  {site.forms?.endpoint && (
    <script is:inline>
      // Progressive enhancement: if an endpoint is configured, submit with fetch and show status.
      (function(){
        const form = document.currentScript?.previousElementSibling?.previousElementSibling;
        // previousElementSibling chain: <p.tip> <- <form> ; adjust robustly:
        const getForm = () => document.querySelector('section#contact form[data-enhanced="true"]');
        const f = getForm();
        if (!f) return;
        const status = f.querySelector('#status');
        f.addEventListener('submit', async (e) => {
          try {
            if (!f.dataset.enhanced) return; // mailto fallback
            e.preventDefault();
            const hp = f.querySelector('input[name="website"]');
            if (hp && hp.value) return; // bot likely
            status?.classList.remove('hidden');
            status && (status.textContent = 'Sendingâ€¦');
            const fd = new FormData(f);
            const res = await fetch(f.action, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });
            if (res.ok) {
              status && (status.textContent = 'Thanks! Your message has been sent.');
              f.reset();
            } else {
              status && (status.textContent = 'Something went wrong. Please try again or email me directly.');
            }
          } catch (err) {
            status && (status.textContent = 'Network error. Please try again later.');
          }
        });
      })();
    </script>
  )}
</section>
